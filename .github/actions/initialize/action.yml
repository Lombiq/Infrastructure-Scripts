name: Initialize

description: > 
  Copies the PowerShell modules to a location defined in PSModulePath (since GHA doesn't allow manipulating 
  environment variables).

runs:
  using: "composite"
  steps:
    - name: Copy Modules
      shell: pwsh
      run: |
        $sourcePath = (Resolve-Path "${{ github.action_path }}/../../..").Path
        $destinationPath = ($env:PSModulePath -split [IO.Path]::PathSeparator)[0]
        foreach ($modulePath in (Get-ChildItem $sourcePath -Recurse -Include "*.psm1"))
        {
          New-Item -ItemType Directory -Path $destinationPath -Name $modulePath.Directory.Name
          Copy-Item $modulePath -Destination (Join-Path -Path $destinationPath -ChildPath $modulePath.Directory.Name)
        }

    - name: Install and Import Modules
      shell: pwsh
      run: |
        Install-Module Az.Storage -AllowClobber -Force
        Install-Module Az.Sql -AllowClobber -Force
        Install-Module Az.Websites -AllowClobber -Force
        Import-Module Get-AzureWebAppConnectionString
        Import-Module Set-AzureWebAppStorageContentFromStorage
        Import-Module Copy-AzureWebAppSqlDatabase