# Measure latency 10 times, ignore the smallest and largest 2 measurements and average the rest.
function Measure-Latency($Url)
{
    $measurements = @()

    for ($i = 0; $i -lt 10; $i++)
    {
        try
        {
            $measurements += (Measure-Command { Invoke-WebRequest $Url -TimeoutSec 1 }).Milliseconds
        }
        catch
        {
            $measurements += 1000
        }
    }

    return (($measurements | Sort-Object)[2..7] | Measure-Object -Average).Average
}

function Find-NearestAzureDatacenter
{
    [CmdletBinding()]
    param
    (
        [string] $GeographyGroup
    )

    process
    {
        $datacentersJson = '[{"displayName":"East US","id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/eastus","metadata":{"geographyGroup":"US","latitude":"37.3719","longitude":"-79.8164","pairedRegion":[{"id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/westus","name":"westus","subscriptionId":null}],"physicalLocation":"Virginia","regionCategory":"Recommended","regionType":"Physical"},"name":"eastus","regionalDisplayName":"(US) East US","subscriptionId":null,"speedTestUrl":"https://speedtesteus.blob.core.windows.net/cb.json"},{"displayName":"East US 2","id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/eastus2","metadata":{"geographyGroup":"US","latitude":"36.6681","longitude":"-78.3889","pairedRegion":[{"id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/centralus","name":"centralus","subscriptionId":null}],"physicalLocation":"Virginia","regionCategory":"Recommended","regionType":"Physical"},"name":"eastus2","regionalDisplayName":"(US) East US 2","subscriptionId":null,"speedTestUrl":"https://speedtesteus2.blob.core.windows.net/cb.json"},{"displayName":"South Central US","id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/southcentralus","metadata":{"geographyGroup":"US","latitude":"29.4167","longitude":"-98.5","pairedRegion":[{"id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/northcentralus","name":"northcentralus","subscriptionId":null}],"physicalLocation":"Texas","regionCategory":"Recommended","regionType":"Physical"},"name":"southcentralus","regionalDisplayName":"(US) South Central US","subscriptionId":null,"speedTestUrl":"https://speedtestscus.blob.core.windows.net/cb.json"},{"displayName":"West US 2","id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/westus2","metadata":{"geographyGroup":"US","latitude":"47.233","longitude":"-119.852","pairedRegion":[{"id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/westcentralus","name":"westcentralus","subscriptionId":null}],"physicalLocation":"Washington","regionCategory":"Recommended","regionType":"Physical"},"name":"westus2","regionalDisplayName":"(US) West US 2","subscriptionId":null,"speedTestUrl":"https://speedtestwestus2.blob.core.windows.net/cb.json"},{"displayName":"West US 3","id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/westus3","metadata":{"geographyGroup":"US","latitude":"33.448376","longitude":"-112.074036","pairedRegion":[{"id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/eastus","name":"eastus","subscriptionId":null}],"physicalLocation":"Phoenix","regionCategory":"Recommended","regionType":"Physical"},"name":"westus3","regionalDisplayName":"(US) West US 3","subscriptionId":null,"speedTestUrl":"https://azurespeedtestwestus3.z1.web.core.windows.net/"},{"displayName":"Australia East","id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/australiaeast","metadata":{"geographyGroup":"Asia Pacific","latitude":"-33.86","longitude":"151.2094","pairedRegion":[{"id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/australiasoutheast","name":"australiasoutheast","subscriptionId":null}],"physicalLocation":"New South Wales","regionCategory":"Recommended","regionType":"Physical"},"name":"australiaeast","regionalDisplayName":"(Asia Pacific) Australia East","subscriptionId":null,"speedTestUrl":"https://speedtestoze.blob.core.windows.net/cb.json"},{"displayName":"Southeast Asia","id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/southeastasia","metadata":{"geographyGroup":"Asia Pacific","latitude":"1.283","longitude":"103.833","pairedRegion":[{"id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/eastasia","name":"eastasia","subscriptionId":null}],"physicalLocation":"Singapore","regionCategory":"Recommended","regionType":"Physical"},"name":"southeastasia","regionalDisplayName":"(Asia Pacific) Southeast Asia","subscriptionId":null,"speedTestUrl":"https://speedtestsea.blob.core.windows.net/cb.json"},{"displayName":"North Europe","id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/northeurope","metadata":{"geographyGroup":"Europe","latitude":"53.3478","longitude":"-6.2597","pairedRegion":[{"id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/westeurope","name":"westeurope","subscriptionId":null}],"physicalLocation":"Ireland","regionCategory":"Recommended","regionType":"Physical"},"name":"northeurope","regionalDisplayName":"(Europe) North Europe","subscriptionId":null,"speedTestUrl":"https://speedtestne.blob.core.windows.net/cb.json"},{"displayName":"Sweden Central","id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/swedencentral","metadata":{"geographyGroup":"Europe","latitude":"60.67488","longitude":"17.14127","pairedRegion":[{"id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/swedensouth","name":"swedensouth","subscriptionId":null}],"physicalLocation":"GÎ£vle","regionCategory":"Recommended","regionType":"Physical"},"name":"swedencentral","regionalDisplayName":"(Europe) Sweden Central","subscriptionId":null,"speedTestUrl":"https://speedtestesc.blob.core.windows.net/cb.json"},{"displayName":"West Europe","id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/westeurope","metadata":{"geographyGroup":"Europe","latitude":"52.3667","longitude":"4.9","pairedRegion":[{"id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/northeurope","name":"northeurope","subscriptionId":null}],"physicalLocation":"Netherlands","regionCategory":"Recommended","regionType":"Physical"},"name":"westeurope","regionalDisplayName":"(Europe) West Europe","subscriptionId":null,"speedTestUrl":"https://speedtestwe.blob.core.windows.net/cb.json"},{"displayName":"Central US","id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/centralus","metadata":{"geographyGroup":"US","latitude":"41.5908","longitude":"-93.6208","pairedRegion":[{"id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/eastus2","name":"eastus2","subscriptionId":null}],"physicalLocation":"Iowa","regionCategory":"Recommended","regionType":"Physical"},"name":"centralus","regionalDisplayName":"(US) Central US","subscriptionId":null,"speedTestUrl":"https://speedtestcus.blob.core.windows.net/cb.json"},{"displayName":"South Africa North","id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/southafricanorth","metadata":{"geographyGroup":"Africa","latitude":"-25.73134","longitude":"28.21837","pairedRegion":[{"id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/southafricawest","name":"southafricawest","subscriptionId":null}],"physicalLocation":"Johannesburg","regionCategory":"Recommended","regionType":"Physical"},"name":"southafricanorth","regionalDisplayName":"(Africa) South Africa North","subscriptionId":null,"speedTestUrl":"https://speedtestsan.blob.core.windows.net/cb.json"},{"displayName":"Central India","id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/centralindia","metadata":{"geographyGroup":"Asia Pacific","latitude":"18.5822","longitude":"73.9197","pairedRegion":[{"id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/southindia","name":"southindia","subscriptionId":null}],"physicalLocation":"Pune","regionCategory":"Recommended","regionType":"Physical"},"name":"centralindia","regionalDisplayName":"(Asia Pacific) Central India","subscriptionId":null,"speedTestUrl":"https://speedtestcentralindia.blob.core.windows.net/cb.json"},{"displayName":"East Asia","id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/eastasia","metadata":{"geographyGroup":"Asia Pacific","latitude":"22.267","longitude":"114.188","pairedRegion":[{"id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/southeastasia","name":"southeastasia","subscriptionId":null}],"physicalLocation":"Hong Kong","regionCategory":"Recommended","regionType":"Physical"},"name":"eastasia","regionalDisplayName":"(Asia Pacific) East Asia","subscriptionId":null,"speedTestUrl":"https://speedtestea.blob.core.windows.net/cb.json"},{"displayName":"Japan East","id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/japaneast","metadata":{"geographyGroup":"Asia Pacific","latitude":"35.68","longitude":"139.77","pairedRegion":[{"id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/japanwest","name":"japanwest","subscriptionId":null}],"physicalLocation":"Tokyo, Saitama","regionCategory":"Recommended","regionType":"Physical"},"name":"japaneast","regionalDisplayName":"(Asia Pacific) Japan East","subscriptionId":null,"speedTestUrl":"https://speedtestjpe.blob.core.windows.net/cb.json"},{"displayName":"Korea Central","id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/koreacentral","metadata":{"geographyGroup":"Asia Pacific","latitude":"37.5665","longitude":"126.978","pairedRegion":[{"id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/koreasouth","name":"koreasouth","subscriptionId":null}],"physicalLocation":"Seoul","regionCategory":"Recommended","regionType":"Physical"},"name":"koreacentral","regionalDisplayName":"(Asia Pacific) Korea Central","subscriptionId":null,"speedTestUrl":"https://speedtestkoreacentral.blob.core.windows.net/cb.json"},{"displayName":"Canada Central","id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/canadacentral","metadata":{"geographyGroup":"Canada","latitude":"43.653","longitude":"-79.383","pairedRegion":[{"id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/canadaeast","name":"canadaeast","subscriptionId":null}],"physicalLocation":"Toronto","regionCategory":"Recommended","regionType":"Physical"},"name":"canadacentral","regionalDisplayName":"(Canada) Canada Central","subscriptionId":null,"speedTestUrl":"https://speedtestcac.blob.core.windows.net/cb.json"},{"displayName":"France Central","id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/francecentral","metadata":{"geographyGroup":"Europe","latitude":"46.3772","longitude":"2.373","pairedRegion":[{"id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/francesouth","name":"francesouth","subscriptionId":null}],"physicalLocation":"Paris","regionCategory":"Recommended","regionType":"Physical"},"name":"francecentral","regionalDisplayName":"(Europe) France Central","subscriptionId":null,"speedTestUrl":"https://speedtestfrc.blob.core.windows.net/cb.json"},{"displayName":"Norway East","id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/norwayeast","metadata":{"geographyGroup":"Europe","latitude":"59.913868","longitude":"10.752245","pairedRegion":[{"id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/norwaywest","name":"norwaywest","subscriptionId":null}],"physicalLocation":"Norway","regionCategory":"Recommended","regionType":"Physical"},"name":"norwayeast","regionalDisplayName":"(Europe) Norway East","subscriptionId":null,"speedTestUrl":"https://azspeednoeast.blob.core.windows.net/cb.json"},{"displayName":"Poland Central","id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/polandcentral","metadata":{"geographyGroup":"Europe","latitude":"52.23334","longitude":"21.01666","pairedRegion":[],"physicalLocation":"Warsaw","regionCategory":"Recommended","regionType":"Physical"},"name":"polandcentral","regionalDisplayName":"(Europe) Poland Central","subscriptionId":null,"speedTestUrl":"https://speedtestplc.blob.core.windows.net/cb.json"},{"displayName":"Switzerland North","id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/switzerlandnorth","metadata":{"geographyGroup":"Europe","latitude":"47.451542","longitude":"8.564572","pairedRegion":[{"id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/switzerlandwest","name":"switzerlandwest","subscriptionId":null}],"physicalLocation":"Zurich","regionCategory":"Recommended","regionType":"Physical"},"name":"switzerlandnorth","regionalDisplayName":"(Europe) Switzerland North","subscriptionId":null,"speedTestUrl":"https://speedtestchn.blob.core.windows.net/cb.json"},{"displayName":"UAE North","id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/uaenorth","metadata":{"geographyGroup":"Middle East","latitude":"25.266666","longitude":"55.316666","pairedRegion":[{"id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/uaecentral","name":"uaecentral","subscriptionId":null}],"physicalLocation":"Dubai","regionCategory":"Recommended","regionType":"Physical"},"name":"uaenorth","regionalDisplayName":"(Middle East) UAE North","subscriptionId":null,"speedTestUrl":"https://speedtestuaen.blob.core.windows.net/cb.json"},{"displayName":"Qatar Central","id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/qatarcentral","metadata":{"geographyGroup":"Middle East","latitude":"25.551462","longitude":"51.439327","pairedRegion":[],"physicalLocation":"Doha","regionCategory":"Recommended","regionType":"Physical"},"name":"qatarcentral","regionalDisplayName":"(Middle East) Qatar Central","subscriptionId":null,"speedTestUrl":"https://speedtestqc.z1.web.core.windows.net/"},{"displayName":"Brazil","id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/brazil","metadata":{"geographyGroup":null,"latitude":null,"longitude":null,"pairedRegion":null,"physicalLocation":null,"regionCategory":"Other","regionType":"Logical"},"name":"brazil","regionalDisplayName":"Brazil","subscriptionId":null,"speedTestUrl":"https://speedtestnea.blob.core.windows.net/cb.json"},{"displayName":"North Central US","id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/northcentralus","metadata":{"geographyGroup":"US","latitude":"41.8819","longitude":"-87.6278","pairedRegion":[{"id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/southcentralus","name":"southcentralus","subscriptionId":null}],"physicalLocation":"Illinois","regionCategory":"Other","regionType":"Physical"},"name":"northcentralus","regionalDisplayName":"(US) North Central US","subscriptionId":null,"speedTestUrl":"https://speedtestnsus.blob.core.windows.net/cb.json"},{"displayName":"West US","id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/westus","metadata":{"geographyGroup":"US","latitude":"37.783","longitude":"-122.417","pairedRegion":[{"id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/eastus","name":"eastus","subscriptionId":null}],"physicalLocation":"California","regionCategory":"Other","regionType":"Physical"},"name":"westus","regionalDisplayName":"(US) West US","subscriptionId":null,"speedTestUrl":"https://speedtestwus.blob.core.windows.net/cb.json"},{"displayName":"West Central US","id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/westcentralus","metadata":{"geographyGroup":"US","latitude":"40.89","longitude":"-110.234","pairedRegion":[{"id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/westus2","name":"westus2","subscriptionId":null}],"physicalLocation":"Wyoming","regionCategory":"Other","regionType":"Physical"},"name":"westcentralus","regionalDisplayName":"(US) West Central US","subscriptionId":null,"speedTestUrl":"https://speedtestwestcentralus.blob.core.windows.net/cb.json"},{"displayName":"Australia Southeast","id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/australiasoutheast","metadata":{"geographyGroup":"Asia Pacific","latitude":"-37.8136","longitude":"144.9631","pairedRegion":[{"id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/australiaeast","name":"australiaeast","subscriptionId":null}],"physicalLocation":"Victoria","regionCategory":"Other","regionType":"Physical"},"name":"australiasoutheast","regionalDisplayName":"(Asia Pacific) Australia Southeast","subscriptionId":null,"speedTestUrl":"https://speedtestozse.blob.core.windows.net/cb.json"},{"displayName":"Japan West","id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/japanwest","metadata":{"geographyGroup":"Asia Pacific","latitude":"34.6939","longitude":"135.5022","pairedRegion":[{"id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/japaneast","name":"japaneast","subscriptionId":null}],"physicalLocation":"Osaka","regionCategory":"Other","regionType":"Physical"},"name":"japanwest","regionalDisplayName":"(Asia Pacific) Japan West","subscriptionId":null,"speedTestUrl":"https://speedtestjpw.blob.core.windows.net/cb.json"},{"displayName":"Korea South","id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/koreasouth","metadata":{"geographyGroup":"Asia Pacific","latitude":"35.1796","longitude":"129.0756","pairedRegion":[{"id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/koreacentral","name":"koreacentral","subscriptionId":null}],"physicalLocation":"Busan","regionCategory":"Other","regionType":"Physical"},"name":"koreasouth","regionalDisplayName":"(Asia Pacific) Korea South","subscriptionId":null,"speedTestUrl":"https://speedtestkoreasouth.blob.core.windows.net/cb.json"},{"displayName":"South India","id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/southindia","metadata":{"geographyGroup":"Asia Pacific","latitude":"12.9822","longitude":"80.1636","pairedRegion":[{"id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/centralindia","name":"centralindia","subscriptionId":null}],"physicalLocation":"Chennai","regionCategory":"Other","regionType":"Physical"},"name":"southindia","regionalDisplayName":"(Asia Pacific) South India","subscriptionId":null,"speedTestUrl":"https://speedtesteastindia.blob.core.windows.net/cb.json"},{"displayName":"West India","id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/westindia","metadata":{"geographyGroup":"Asia Pacific","latitude":"19.088","longitude":"72.868","pairedRegion":[{"id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/southindia","name":"southindia","subscriptionId":null}],"physicalLocation":"Mumbai","regionCategory":"Other","regionType":"Physical"},"name":"westindia","regionalDisplayName":"(Asia Pacific) West India","subscriptionId":null,"speedTestUrl":"https://speedtestwestindia.blob.core.windows.net/cb.json"},{"displayName":"Canada East","id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/canadaeast","metadata":{"geographyGroup":"Canada","latitude":"46.817","longitude":"-71.217","pairedRegion":[{"id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/canadacentral","name":"canadacentral","subscriptionId":null}],"physicalLocation":"Quebec","regionCategory":"Other","regionType":"Physical"},"name":"canadaeast","regionalDisplayName":"(Canada) Canada East","subscriptionId":null,"speedTestUrl":"https://speedtestcae.blob.core.windows.net/cb.json"},{"displayName":"Germany North","id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/germanynorth","metadata":{"geographyGroup":"Europe","latitude":"53.073635","longitude":"8.806422","pairedRegion":[{"id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/germanywestcentral","name":"germanywestcentral","subscriptionId":null}],"physicalLocation":"Berlin","regionCategory":"Other","regionType":"Physical"},"name":"germanynorth","regionalDisplayName":"(Europe) Germany North","subscriptionId":null,"speedTestUrl":"https://speedtestden.blob.core.windows.net/cb.json"},{"displayName":"Switzerland West","id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/switzerlandwest","metadata":{"geographyGroup":"Europe","latitude":"46.204391","longitude":"6.143158","pairedRegion":[{"id":"/subscriptions/f04789ac-5112-4bb1-8725-eb44038c5273/locations/switzerlandnorth","name":"switzerlandnorth","subscriptionId":null}],"physicalLocation":"Geneva","regionCategory":"Other","regionType":"Physical"},"name":"switzerlandwest","regionalDisplayName":"(Europe) Switzerland West","subscriptionId":null,"speedTestUrl":"https://speedtestchw.blob.core.windows.net/cb.json"}]'

        $datacenters = $datacentersJson | ConvertFrom-Json -Depth 9

        if ($GeographyGroup)
        {
            $datacenters = $datacenters | Where-Object { $PSItem.metadata.geographyGroup -eq $GeographyGroup }
        }

        foreach ($datacenter in $datacenters)
        {
            $datacenter | Add-Member -MemberType NoteProperty -Name 'latency' -Value (Measure-Latency $datacenter.speedTestUrl)
        }

        return ($datacenters | Sort-Object latency)[0]
    }
}
